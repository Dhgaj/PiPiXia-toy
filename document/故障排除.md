# PiPiXia 故障排除指南

本文档提供了 PiPiXia 编译器使用过程中可能遇到的问题和解决方案。

## 📚 目录

- [环境问题](#环境问题)
- [编译问题](#编译问题)
- [运行问题](#运行问题)
- [性能基准](#性能基准)
- [日志和诊断](#日志和诊断)

---

## 环境问题

### 1. 平台检测失败

**问题描述**: 运行脚本时提示平台不支持或检测失败。

**解决方法**:
```bash
# 运行平台检测脚本
./scripts/01_detect_platform.sh

# 查看生成的配置
cat .platform_config

# 手动验证环境
flex --version
bison --version
llvm-config --version
g++ --version
```

**支持的平台**:
- macOS (Apple Silicon - M1/M2/M3)
- macOS (Intel)
- Ubuntu 24.04
- Ubuntu 22.04

---

### 2. LLVM 配置问题

**问题描述**: 编译时找不到 LLVM 库或头文件。

**macOS 解决方法**:
```bash
# 1. 确保 LLVM 已安装
brew install llvm

# 2. 配置环境变量（添加到 ~/.zshrc）
export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
export LDFLAGS="-L/opt/homebrew/opt/llvm/lib"
export CPPFLAGS="-I/opt/homebrew/opt/llvm/include"

# 3. 重新加载配置
source ~/.zshrc

# 4. 验证配置
llvm-config --version
llvm-config --prefix
```

**Ubuntu 解决方法**:
```bash
# 1. 安装 LLVM 开发包
sudo apt update
sudo apt install llvm llvm-dev

# 2. 验证安装
llvm-config --version
which llvm-config

# 3. 如果找不到，添加到 PATH
export PATH="/usr/bin:$PATH"
```

---

### 3. 工具版本不兼容

**问题描述**: 工具版本过旧或过新导致编译失败。

**推荐版本**:

| 工具 | macOS | Ubuntu |
|------|-------|--------|
| LLVM | 21+ | 21+ |
| Flex | 2.6+ | 2.6+ |
| Bison | 3.8+ | 3.8+ |
| g++ | 11+ | 11+ |
| Make | 4.0+ | 4.0+ |

**版本检查**:
```bash
# 一键检查所有工具版本
make info

# 或逐个检查
flex --version
bison --version
llvm-config --version
g++ --version
make --version
```

---

## 编译问题

### 1. 编译器构建失败

**问题描述**: `make` 命令失败。

**解决步骤**:

**Step 1: 清理构建**
```bash
make clean
```

**Step 2: 检查依赖**
```bash
# 检查必要工具
which flex
which bison
which g++
which llvm-config

# 如果缺少，安装相应工具
```

**Step 3: 重新构建**
```bash
make
```

**Step 4: 查看详细错误**
```bash
make VERBOSE=1  # 显示详细编译命令
```

---

### 2. 词法分析器生成失败

**问题描述**: Flex 生成 `lexical.cc` 失败。

**常见原因**:
1. Flex 未安装或版本过旧
2. `lexical.l` 文件语法错误

**解决方法**:
```bash
# 1. 验证 Flex
flex --version

# 2. 手动生成
flex -o lexical.cc lexical.l

# 3. 查看错误信息
# 如果有语法错误，Flex 会给出行号
```

---

### 3. 语法分析器生成失败

**问题描述**: Bison 生成 `syntax.cc` 失败。

**常见原因**:
1. Bison 未安装或版本过旧
2. `syntax.y` 文件语法错误
3. 冲突规则（shift/reduce 或 reduce/reduce）

**解决方法**:
```bash
# 1. 验证 Bison
bison --version

# 2. 手动生成并查看详细信息
bison -d -v syntax.y -o syntax.cc

# 3. 查看冲突报告
cat syntax.output

# 4. 如果有冲突，修改语法规则
```

---

### 4. 链接错误

**问题描述**: 编译对象文件成功，但链接失败。

**常见错误信息**:
```
undefined reference to `LLVMxxxx`
ld: library not found for -lLLVM
```

**解决方法**:

**macOS**:
```bash
# 确保 LLVM 库路径正确
export LDFLAGS="-L/opt/homebrew/opt/llvm/lib"
make clean && make
```

**Ubuntu**:
```bash
# 安装 LLVM 21 开发库
sudo apt install llvm-21-dev liblld-21-dev

# 或指定库路径
export LD_LIBRARY_PATH="/usr/lib/llvm-21/lib:$LD_LIBRARY_PATH"
make clean && make
```

---

## 运行问题

### 1. 编译 PPX 程序失败

**问题描述**: `./compiler program.ppx` 失败。

**诊断步骤**:

**Step 1: 语法检查**
```bash
# 查看详细错误信息
./compiler program.ppx -v
```

**Step 2: 分段测试**
```bash
# 测试词法分析
./compiler program.ppx -tokens

# 测试语法分析
./compiler program.ppx -ast

# 测试代码生成
./compiler program.ppx -llvm
```

**Step 3: 参考示例**
```bash
# 对比正确的示例
cat code/01_hello_world.ppx
./compiler code/01_hello_world.ppx
```

---

### 2. 运行时崩溃

**问题描述**: 编译成功但执行时崩溃。

**常见原因和解决方法**:

**数组越界**:
```ppx
# 问题代码
let arr: int[5] = [1, 2, 3, 4, 5]
print(arr[10])  # 越界！

# 解决方法
# 确保索引在有效范围内 [0, 4]
print(arr[4])
```

**除零错误**:
```ppx
# 问题代码
let x: int = 10
let y: int = 0
let result: int = x / y  # 除零！

# 解决方法
# 添加检查
if (y != 0) {
    let result: int = x / y
} else {
    print("错误：除数不能为零")
}
```

**未初始化变量**:
```ppx
# 问题代码
let x: int
print(x)  # 未初始化！

# 解决方法
let x: int = 0  # 总是初始化变量
print(x)
```

---

### 3. 输出结果不正确

**问题描述**: 程序运行但结果错误。

**调试方法**:

**1. 添加调试输出**:
```ppx
func calculate(x: int): int {
    print("输入: ${x}")
    let temp: int = x * 2
    print("中间结果: ${temp}")
    let result: int = temp + 5
    print("最终结果: ${result}")
    return result
}
```

**2. 查看 LLVM IR**:
```bash
./compiler program.ppx -llvm
cat program.ll  # 检查生成的中间代码
```

**3. 类型检查**:
```ppx
# 确保类型匹配
let x: int = 10
let y: double = 3.14
let result: double = x + y  # 正确：混合类型运算
```

---

### 4. 内存相关问题

**问题描述**: 字符串或数组操作导致内存错误。

**常见场景**:

**字符串插值**:
```ppx
# 正确用法
let name: string = "Alice"
print("Hello, ${name}!")

# 避免过度复杂的插值
let complex: string = "${${name}}"  # 可能有问题
```

**数组操作**:
```ppx
# 避免越界
let arr: int[10]
for i in 0..10 {  # 正确：0-9
    arr[i] = i
}
```

---

## 性能基准

### 编译速度

典型 PPX 程序的编译时间（在 M1 MacBook Pro 上测试）：

| 程序大小 | 行数 | 编译时间 | 生成文件大小 |
|---------|------|----------|--------------|
| **极小** | < 50 | < 0.3秒 | ~50KB |
| **小型** | 50-100 | 0.3-0.5秒 | ~100KB |
| **中型** | 100-500 | 0.5-2秒 | ~200KB |
| **大型** | 500-1000 | 2-5秒 | ~500KB |
| **超大** | > 1000 | 5-10秒 | ~1MB |

### 运行性能

PPX 生成的代码经过 LLVM 优化，性能接近 C/C++：

| 操作类型 | 相对性能 | 说明 |
|---------|---------|------|
| **算术运算** | 100% | 与 C 相当 |
| **函数调用** | 95% | 轻量级，几乎无开销 |
| **数组访问** | 90% | 带边界检查，略有开销 |
| **字符串操作** | 85% | 涉及内存管理 |
| **循环** | 98% | LLVM 优化后接近原生 |

### 优化建议

**编译时优化**:
```bash
# 使用并行编译
make -j4

# 增量编译（不清理）
make
```

**代码优化**:
```ppx
# 1. 使用合适的类型
let count: int = 0  # 而不是 double

# 2. 减少类型转换
let x: int = 10
let y: int = 20
let sum: int = x + y  # 避免转换为 double

# 3. 缓存循环条件
let len: int = 1000
for i in 0..len {  # 而不是每次计算
    # ...
}
```

---

## 日志和诊断

### 1. 启用详细输出

**编译器详细模式**:
```bash
./compiler program.ppx -v
```

**输出内容**:
- ✅ 词法分析统计（Token 数量、类型）
- ✅ AST 解析详情（函数、变量、语句）
- ✅ LLVM IR 生成步骤
- ✅ 编译链接命令

### 2. 查看中间文件

**Token 流**:
```bash
./compiler program.ppx -tokens
cat program.tokens
```

**AST 结构**:
```bash
./compiler program.ppx -ast
cat program.ast

# 可视化
./scripts/06_visualize_ast.sh
```

**LLVM IR**:
```bash
./compiler program.ppx -llvm
cat program.ll
```

### 3. 测试报告

**运行完整测试**:
```bash
./scripts/05_run_tests.sh
```

**查看测试报告**:
```bash
# 报告保存在 report/ 目录
ls -lt report/
cat report/test_report_*.md
```

**报告内容**:
- 每个测试的编译结果
- 运行输出
- 成功/失败统计
- 执行时间

### 4. 系统诊断

**一键诊断**:
```bash
# 检查环境配置
./scripts/01_detect_platform.sh

# 查看工具版本
make info

# 验证编译器
./compiler -h
```

**详细检查**:
```bash
# 检查可执行文件
which flex bison llvm-config g++ make

# 检查库路径
echo $PATH
echo $LDFLAGS
echo $CPPFLAGS

# 检查 LLVM 配置
llvm-config --version
llvm-config --prefix
llvm-config --libdir
llvm-config --includedir
```

---

## 常见错误代码

| 错误代码 | 含义 | 解决方法 |
|---------|------|----------|
| **Exit 1** | 编译失败 | 检查语法错误，使用 `-v` 查看详情 |
| **Exit 126** | 权限不足 | `chmod +x` 添加执行权限 |
| **Exit 127** | 命令未找到 | 检查 PATH 环境变量 |
| **Exit 139** | 段错误 | 检查数组越界、空指针 |

---

## 获取帮助

如果以上方法都无法解决问题：

### 1. 收集诊断信息

```bash
# 创建诊断报告
{
    echo "=== 系统信息 ==="
    uname -a
    
    echo -e "\n=== 工具版本 ==="
    flex --version
    bison --version
    llvm-config --version
    g++ --version
    
    echo -e "\n=== 环境变量 ==="
    echo "PATH=$PATH"
    echo "LDFLAGS=$LDFLAGS"
    echo "CPPFLAGS=$CPPFLAGS"
    
    echo -e "\n=== 编译测试 ==="
    ./compiler code/01_hello_world.ppx -v
} > diagnostic_report.txt
```

### 2. 联系支持

- 📧 **邮箱**: sifanlian@gmail.com
- 🐛 **GitHub Issues**: 报告 Bug
- 💬 **GitHub Discussions**: 提问和讨论

### 3. 提供信息

在报告问题时，请提供：
- 操作系统和版本
- 工具版本（flex, bison, LLVM, g++）
- 完整的错误信息
- 重现步骤
- 诊断报告文件

---

## 相关文档

- [FAQ.md](./FAQ.md) - 常见问题快速解答
- [PPX语法教程.md](./PPX语法教程.md) - 完整语法参考
- [脚本工具使用指南.md](./脚本工具使用指南.md) - 自动化工具说明

---

**最后更新**: 2025-12-19
